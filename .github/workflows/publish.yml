name: Publish to NPM

on:
  push:
    branches: [main]
    paths:
      - 'packages/*/package.json'
      - 'packages/*/index.ts'
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: oven-sh/setup-bun@v1
      
      - name: Setup NPM
        run: |
          npm config set //registry.npmjs.org/:_authToken ${{ secrets.NPM_TOKEN }}
          
      - name: Publish packages
        run: |
          # Manual trigger = publish all
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            for dir in packages/*/; do
              if [ -f "$dir/package.json" ]; then
                cd $dir
                npm publish --access public || echo "Already published or error"
                cd ../..
              fi
            done
          else
            # Auto trigger = only changed
            git diff --name-only HEAD~1 2>/dev/null | grep "packages/" | cut -d/ -f2 | sort -u | while read package; do
              if [ -d "packages/$package" ]; then
                cd packages/$package
                npm version patch --no-git-tag-version
                npm publish --access public || echo "Already published or error"
                cd ../..
              fi
            done
          fi